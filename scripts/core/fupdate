#!/usr/bin/env bash
# shellcheck shell=bash
# shfmt: -ln=bash
#
# fupdate - System update script for dotbuntu
#
# Updates the system using the appropriate package manager:
# - Arch Linux: pacman -Syu
# - Ubuntu/Debian: apt update && apt upgrade
#
# @params
# Globals:
#   None specific to this script
# Arguments:
#   -h|--help: Show help message and exit
# Returns:
#   0 on success
#   1 on failure

set -Eeuo pipefail

# Determine script directory
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly HELPER_DIR="${SCRIPT_DIR}/../../helper"

# Source required helpers
# shellcheck source=/dev/null
source "${HELPER_DIR}/load_helpers.sh"
load_helpers "${HELPER_DIR}" colors logger prompts
# shellcheck source=/dev/null
source "${SCRIPT_DIR}/../scripts/deprecated/package_manager.sh"

# Setup error trap
trap on_error ERR

#######################################
# Display usage information
# Outputs:
#   Help text for fupdate
#######################################
function usage() {
    local manager_name
    manager_name=$(pkg_get_manager_name)
    echo -e "Usage: fupdate [-h]

Update system packages using $manager_name.
This ensures the system is up-to-date before installing additional packages.

Supported systems:
  - Arch Linux (pacman -Syu)
  - Ubuntu/Debian (apt update && apt upgrade)

Optional arguments:
  -h, --help\t\tshow this help message and exit."
}

#######################################
# Main function - update system
# Performs full system update with the appropriate package manager
#######################################
function main() {
    # Parse arguments
    if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
        usage
        exit 0
    fi
    
    clear 2>/dev/null || true
    logo "Actualizando el sistema"
    sleep 1
    
    local manager
    manager=$(pkg_get_manager)
    local manager_name
    manager_name=$(pkg_get_manager_name)
    
    info "Gestor de paquetes detectado: $manager_name"
    info "Actualizando sistema..."
    echo ""
    
    # Run system update using abstraction layer
    if pkg_upgrade; then
        echo ""
        printf "%b\n" "${BLD}${CGR}âœ“ Sistema actualizado correctamente!${CNC}"
    else
        log_error "Error al actualizar el sistema"
        return 1
    fi
    
    sleep 2
}

# Execute only if invoked directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi

